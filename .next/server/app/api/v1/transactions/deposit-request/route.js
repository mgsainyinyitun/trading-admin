"use strict";(()=>{var e={};e.id=6956,e.ids=[6956],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},14578:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>N,requestAsyncStorage:()=>A,routeModule:()=>y,serverHooks:()=>z,staticGenerationAsyncStorage:()=>b});var n={};t.r(n),t.d(n,{OPTIONS:()=>w,POST:()=>v});var s=t(49303),i=t(88716),o=t(60670),a=t(87070);let u=require("fs/promises");var c=t(55315),d=t(7410),p=t(96799),l=t(53696),m=t(72331),f=t(50650),g=t(92048);let h=e=>{let r={"Access-Control-Allow-Methods":`${process.env.ALLOWED_METHODS}`,"Access-Control-Allow-Headers":`${process.env.ALLOWED_HEADERS}`,"Access-Control-Allow-Origin":`${process.env.DOMAIN_URL}`};if(!process.env.ALLOWED_ORIGIN||!e)return r;let t=process.env.ALLOWED_ORIGIN.split(",");return t.includes("*")?r["Access-Control-Allow-Origin"]="*":t.includes(e)&&(r["Access-Control-Allow-Origin"]=e),r},w=async e=>a.NextResponse.json({},{status:200,headers:h(e.headers.get("origin")||"")});async function v(e){try{let r=await (0,l.H)(e);if(!r)return a.NextResponse.json({error:"Unauthorized"},{status:401,headers:h(e.headers.get("origin")||"")});let t=await e.formData(),n=t.get("file"),s=p.$y.parse({currency:t.get("currency"),amount:t.get("amount"),description:t.get("description")});if(!n)return a.NextResponse.json({success:!1,error:"No file uploaded"},{status:400,headers:h(e.headers.get("origin")||"")});let i=await m._.account.findMany({where:{customerId:Number(r.customer?.id)}});if(!i)return a.NextResponse.json({error:"Account not found or access denied"},{status:404,headers:h(e.headers.get("origin")||"")});let o=i.find(e=>e.currency.toLocaleLowerCase()===s.currency.toLocaleLowerCase());if(o||(o=await m._.account.create({data:{customerId:Number(r.customer?.id),currency:s.currency,accountNo:function(){let e=Date.now().toString(),r=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return`${e}${r}`}(),balance:0,isActive:!0,updatedAt:new Date}})),!o)return a.NextResponse.json({success:!1,error:"Account not found"},{status:404,headers:h(e.headers.get("origin")||"")});let d=await n.arrayBuffer(),w=Buffer.from(d),v=(0,f.l)();n.name;let y=(0,c.join)(process.cwd(),"public/uploads");(0,g.existsSync)(y)||await (0,u.mkdir)(y,{recursive:!0});let A=(0,c.join)(process.cwd(),"public/uploads",n.name);await (0,u.writeFile)(A,new Uint8Array(w));let b=await m._.$transaction(async e=>{let r=await e.transaction.create({data:{transactionId:v,type:"DEPOSIT",amount:s.amount,description:s.description,status:"PENDING",accountId:o?.id,updatedAt:new Date}});await e.account.update({where:{id:o.id},data:{inreview_balance:{increment:s.amount}}});let t=await e.transactionfile.create({data:{transactionId:r.id,filePath:A,updatedAt:new Date}});return await e.account.update({where:{id:o.id},data:{inreview_balance:{increment:s.amount}}}),{transaction:r,transactionFile:t}});return a.NextResponse.json({success:!0,transaction:b.transaction},{headers:h(e.headers.get("origin")||"")})}catch(r){if(r instanceof d.z.ZodError)return a.NextResponse.json({success:!1,error:r.errors},{status:400,headers:h(e.headers.get("origin")||"")});return console.error("Error processing deposit:",r),a.NextResponse.json({success:!1,error:"Internal Server Error"},{status:500,headers:h(e.headers.get("origin")||"")})}}let y=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/v1/transactions/deposit-request/route",pathname:"/api/v1/transactions/deposit-request",filename:"route",bundlePath:"app/api/v1/transactions/deposit-request/route"},resolvedPagePath:"C:\\Users\\sainyi\\Desktop\\projects\\others\\trading-admin\\app\\api\\v1\\transactions\\deposit-request\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:A,staticGenerationAsyncStorage:b,serverHooks:z}=y,x="/api/v1/transactions/deposit-request/route";function N(){return(0,o.patchFetch)({serverHooks:z,staticGenerationAsyncStorage:b})}},90455:(e,r,t)=>{t.d(r,{Og:()=>c,Rp:()=>o,Ym:()=>a,so:()=>i});var n=t(24295),s=t(72331);function i(e){let r=e.headers.get("authorization");return r?.startsWith("Bearer ")?r.split(" ")[1]:null}async function o(e){try{if(await u(e))return null;let r=(0,n.WX)(e);return{id:r.customerId,email:r.email}}catch(e){return null}}async function a(e){let r=i(e);return r?o(r):null}async function u(e){let r=await s._.invalidtoken.findUnique({where:{token:e}});return!!r&&(!(r.expiresAt<new Date)||(await s._.invalidtoken.delete({where:{id:r.id}}),!1))}async function c(e,r){await s._.invalidtoken.create({data:{token:e,expiresAt:r}})}},24295:(e,r,t)=>{t.d(r,{RA:()=>o,WX:()=>a});var n=t(41482),s=t.n(n);let i=process.env.JWT_SECRET||"your-secret-key",o=e=>s().sign(e,i,{expiresIn:"30d"}),a=e=>{try{return s().verify(e,i)}catch(e){throw Error("Invalid token")}}},72331:(e,r,t)=>{t.d(r,{_:()=>s});var n=t(53524);let s=global.prisma||new n.PrismaClient({log:["query"]})},50650:(e,r,t)=>{function n(){let e=Date.now().toString(36),r=Math.random().toString(36).substring(2,8);return`TXN${e}${r}`.toUpperCase()}function s(e,r){if(!e)return!1;{let t=Math.random()<=e;return t&&(t=Math.random()<=r),t}}t.d(r,{V:()=>s,l:()=>n})},53696:(e,r,t)=>{t.d(r,{H:()=>s});var n=t(90455);async function s(e){try{let r=(0,n.so)(e);if(!r)return{error:"Authentication required",status:401};let t=await (0,n.Rp)(r);if(!t)return{error:"Invalid or expired token",status:401};return{customer:t,status:200}}catch(e){return console.error("Error in authentication:",e),{error:"Authentication failed",status:500}}}},96799:(e,r,t)=>{t.d(r,{$y:()=>u,GE:()=>o,X5:()=>a,dX:()=>i,p$:()=>s});var n=t(7410);let s=n.z.object({accountNo:n.z.string().min(1,"Account number is required"),amount:n.z.string().or(n.z.number()).transform(e=>{let r="string"==typeof e?parseFloat(e):e;if(isNaN(r)||r<=0)throw Error("Amount must be a positive number");return r}),description:n.z.string().optional()}),i=n.z.object({address:n.z.string().min(1,"Address is required"),currency:n.z.string(),amount:n.z.string().or(n.z.number()).transform(e=>{let r="string"==typeof e?parseFloat(e):e;if(isNaN(r)||r<=0)throw Error("Amount must be a positive number");return r}),description:n.z.string().optional()}),o=n.z.object({customerId:n.z.number().int().positive(),currency:n.z.string().min(1),tradeType:n.z.enum(["SHORT","LONG"]),period:n.z.number().int().positive(),tradeQuantity:n.z.number().int().positive()}),a=n.z.object({customerId:n.z.number().int().positive(),tradeId:n.z.number().int().positive(),outcome:n.z.enum(["win","lose"]).nullable()}),u=n.z.object({currency:n.z.string().min(1,"Currency is required"),amount:n.z.string().or(n.z.number()).transform(e=>{let r="string"==typeof e?Number.parseFloat(e):e;if(isNaN(r)||r<=0)throw Error("Amount must be a positive number");return r}),description:n.z.string().optional()})}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[8948,5972,1482,7410],()=>t(14578));module.exports=n})();