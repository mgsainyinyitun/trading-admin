"use strict";(()=>{var e={};e.id=9430,e.ids=[9430],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},31444:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{OPTIONS:()=>p,POST:()=>l});var o=r(49303),a=r(88716),s=r(60670),i=r(72331),u=r(87070),c=r(96799);let d=e=>{let t={"Access-Control-Allow-Methods":`${process.env.ALLOWED_METHODS}`,"Access-Control-Allow-Headers":`${process.env.ALLOWED_HEADERS}`,"Access-Control-Allow-Origin":`${process.env.DOMAIN_URL}`};if(!process.env.ALLOWED_ORIGIN||!e)return t;let r=process.env.ALLOWED_ORIGIN.split(",");return r.includes("*")?t["Access-Control-Allow-Origin"]="*":r.includes(e)&&(t["Access-Control-Allow-Origin"]=e),t},p=async e=>u.NextResponse.json({},{status:200,headers:d(e.headers.get("origin")||"")});async function l(e){if("POST"===e.method){let t=await e.json(),{customerId:r,tradeType:n,period:o,tradeQuantity:a,currency:s}=c.GE.parse(t),p=await i._.account.findMany({where:{customerId:Number(r)}}),l=p.find(e=>e.currency.toLocaleLowerCase()===s.toLocaleLowerCase());if(l||(l=await i._.account.create({data:{customerId:r,currency:s,balance:0,accountNo:function(){let e=Date.now().toString(),t=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return`${e}${t}`}(),updatedAt:new Date}})),!p||!l)return u.NextResponse.json({error:"Account not found or access denied"},{status:404,headers:d(e.headers.get("origin")||"")});let m=0;for(let e of p)if("usd"!==e.currency.toLocaleLowerCase()){if(["btc","eth","usdt","usdc"].includes(e.currency.toLowerCase()))try{let t=await fetch(`https://min-api.cryptocompare.com/data/price?fsym=${e.currency}&tsyms=USD`),r=(await t.json()).USD;m+=parseFloat(e.balance.toString())*r}catch(t){console.error(`Error fetching price for ${e.currency}:`,t),m+=parseFloat(e.balance.toString())}else m+=parseFloat(e.balance.toString())}if(m<a)return u.NextResponse.json({error:"Insufficient balance"},{status:400,headers:d(e.headers.get("origin")||"")});let g=await i._.tradingsetting.findFirst({where:{seconds:o,tradingType:n}});g||(g=await i._.tradingsetting.create({data:{seconds:o,tradingType:n,percentage:{30:40,60:50,120:70,300:100}[o]||40,winRate:.5,createdAt:new Date,updatedAt:new Date}}));let h=[],f=Math.round(o*g.winRate),w=o-f;for(let e=0;e<f;e++)h.push(1);for(let e=0;e<w;e++)h.push(0);for(let e=h.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1));[h[e],h[t]]=[h[t],h[e]]}try{let t=await i._.trade.create({data:{customerId:r,accountId:l.id,tradeType:n,period:o,tradingStatus:"PENDING",tradeQuantity:a,updatedAt:new Date}});return u.NextResponse.json({trade:t,sequence:h},{headers:d(e.headers.get("origin")||"")})}catch(t){return u.NextResponse.json({error:"Error creating trade"},{headers:d(e.headers.get("origin")||"")})}}return u.NextResponse.json({error:"Method not allowed"},{headers:d(e.headers.get("origin")||"")})}let m=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/v1/trade-request/route",pathname:"/api/v1/trade-request",filename:"route",bundlePath:"app/api/v1/trade-request/route"},resolvedPagePath:"C:\\Users\\sainyi\\Desktop\\projects\\others\\trading-admin\\app\\api\\v1\\trade-request\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:f}=m,w="/api/v1/trade-request/route";function b(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},72331:(e,t,r)=>{r.d(t,{_:()=>o});var n=r(53524);let o=global.prisma||new n.PrismaClient({log:["query"]})},96799:(e,t,r)=>{r.d(t,{$y:()=>u,GE:()=>s,X5:()=>i,dX:()=>a,p$:()=>o});var n=r(7410);let o=n.z.object({accountNo:n.z.string().min(1,"Account number is required"),amount:n.z.string().or(n.z.number()).transform(e=>{let t="string"==typeof e?parseFloat(e):e;if(isNaN(t)||t<=0)throw Error("Amount must be a positive number");return t}),description:n.z.string().optional()}),a=n.z.object({address:n.z.string().min(1,"Address is required"),currency:n.z.string(),amount:n.z.string().or(n.z.number()).transform(e=>{let t="string"==typeof e?parseFloat(e):e;if(isNaN(t)||t<=0)throw Error("Amount must be a positive number");return t}),description:n.z.string().optional()}),s=n.z.object({customerId:n.z.number().int().positive(),currency:n.z.string().min(1),tradeType:n.z.enum(["SHORT","LONG"]),period:n.z.number().int().positive(),tradeQuantity:n.z.number().int().positive()}),i=n.z.object({customerId:n.z.number().int().positive(),tradeId:n.z.number().int().positive(),outcome:n.z.enum(["win","lose"]).nullable()}),u=n.z.object({currency:n.z.string().min(1,"Currency is required"),amount:n.z.string().or(n.z.number()).transform(e=>{let t="string"==typeof e?Number.parseFloat(e):e;if(isNaN(t)||t<=0)throw Error("Amount must be a positive number");return t}),description:n.z.string().optional()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,7410],()=>r(31444));module.exports=n})();